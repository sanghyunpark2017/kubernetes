

#배경
-보안로그통합 ELk 및 kibana로 구현하는 중 kibana에 보안기능(로그인화면)이 없음
-보안기능을 사용하려면 gold subscription를 구매해야하며, 년간 약 1600만원 발생 (노드당 520만원, 최소 3노드 필요)
-비용 없이 구현하는 방안 마련 

#방안
-kibana 로그인을 nginx proxy로 구현
-docker로 하며 official nginx를 다운로드 받아서 로컬이미지화 함
-official nginx가 우부트 기반임

docker pull nginx:lates

docker run -dit -p 32001:80 --name "mynginx" nginx
 

docker exec -it mynginx /bin/bash


apt-get -y update
apt-get install -y apache2-utils vim


htpasswd -c /etc/nginx/.htpasswd hmplogadm
>>logmon/4u

cat /etc/nginx/.htpasswd
 
cd /etc/nginx/conf.d
cp default.conf default.conf.org


----------------------------------------------------------------
cat << EOF > /etc/nginx/conf.d/default.conf
server {
  listen *:80;
  server_name _;
  location / {
    proxy_pass http://10.10.64.91:5601;
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;
  }
}  
EOF
-----------------------------------------------------------------

cat /etc/nginx/conf.d/default.conf

#변경된 설정이 동작하는지 중지 후 재시작

exit

docker stop mynginx
docker start mynginx
docker logs mynginx

#현재 머신에서 expose후 kibana로 proxy되는지 테스트

curl localhost:32001

http://10.10.64.90:32001



#이제 이미지 tag 후 업로드 하고
kube에서는 .htpasswd 파일과 nginx.conf 파일을 외부로 뺀다.
그러면,, RUNNING 중 암호변경 후 재기동하여 암호 변경이 쉽게 될 수 있ㄷ

+kube로 뺀다.
+nginx에 ssl
+otp 인증
++초화면 디자인 가능한지





