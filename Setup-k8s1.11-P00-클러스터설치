

##############################
Before you begin
##############################

-Three machines that meet kubeadm’s minimum requirements for the masters
-Three machines that meet kubeadm’s minimum requirements for the workers
-Full network connectivity between all machines in the cluster (public or private network is fine)
-SSH access from one device to all nodes in the system (마스터 3대와 워커 3대)
-sudo privileges on all machines

################
##SSH
################

cat << EOF >> /etc/hosts
#kubernetes master
10.10.64.61  t1vkubeadm1
10.10.64.62  t1vkubeadm2
10.10.64.63  t1vkubeadm3

#kubernetes worker
10.10.64.64  t1vkubework1
10.10.64.65  t1vkubework2
10.10.64.66  t1vkubework3

#kubernetes etcd
10.10.64.96  t1vkubeetcd1
10.10.64.97  t1vkubeetcd2
10.10.64.98  t1vkubeetcd3
EOF

ssh-keygen -t rsa

ssh-copy-id -i ~/.ssh/id_rsa.pub root@t1vkubeadm1
ssh-copy-id -i ~/.ssh/id_rsa.pub root@t1vkubeadm2
ssh-copy-id -i ~/.ssh/id_rsa.pub root@t1vkubeadm3

ssh-copy-id -i ~/.ssh/id_rsa.pub root@t1vkubework1
ssh-copy-id -i ~/.ssh/id_rsa.pub root@t1vkubework2
ssh-copy-id -i ~/.ssh/id_rsa.pub root@t1vkubework3

ssh-copy-id -i ~/.ssh/id_rsa.pub root@t1vkubeetcd1
ssh-copy-id -i ~/.ssh/id_rsa.pub root@t1vkubeetcd2
ssh-copy-id -i ~/.ssh/id_rsa.pub root@t1vkubeetcd3


################################################################
##Installing prerequisites on masters and workers
################################################################

#방화벽 일단 셧다운
systemctl disable firewalld
systemctl stop firewalld

###Installing Docker
#Docker Version 17.03 is recommended. Versions 17.06+ might work

sudo yum install -y yum-utils \
  device-mapper-persistent-data \
  lvm2

sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo

yum list docker-ce --showduplicates | sort -r


yum install -y --setopt=obsoletes=0 \
  docker-ce-17.03.1.ce-1.el7.centos \
  docker-ce-selinux-17.03.1.ce-1.el7.centos

systemctl enable docker && systemctl start docker
systemctl status docker


###Installing kubeadm, kubelet and kubect
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF

setenforce 0 

vi /etc/selinux/config
SELINUX=disabled


yum install -y kubelet kubeadm kubectl
systemctl enable kubelet && systemctl start kubelet
systemctl status kubelet


cat <<EOF >  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system


###Configure cgroup driver used by kubelet on Master Node
docker info | grep -i cgroup
cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf

#만약 systemd가 아니고 cgroupfs인 경우
#sed -i "s/cgroup-driver=systemd/cgroup-driver=cgroupfs/g" /etc/systemd/system/kubelet.service.d/10-kubeadm.conf

systemctl daemon-reload
systemctl restart kubelet

systemctl status kubelet


 



